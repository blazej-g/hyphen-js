/**
 * Hyphen Js - Generic Angular application data layer
 * @version v0.0.283 - 2016-03-16 * @link 
 * @author Blazej Grzelinski
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */var jsHyphen=angular.module("jsHyphen",[]);!function(){jsHyphen.provider("Hyphen",[function(){var a={};return a.initialize=function(){},a.$get=["$rootScope","$http","$q","BasicModel","HyphenIndexDb","$injector","$timeout","CacheService","HyphenSynchronizer","OfflineOnlineService",function(a,b,c,d,e,f,g,h,i,j){var k,l,m,n={},o=[],p=[];n.initialize=function(a){this.configuration=a,k=a,m=new i(a),a.model.forEach(function(b){n[b.model]=new d(b,a);var c={name:b.model,key:b.key,priority:b.priority,sync:b.sync,foreignKeys:b.foreignKeys};b.sync?o.push(c):p.push(c)})},n.dispose=function(){h.clearCache(),e.closeDb()},n.getState=function(){return j.getState()},n.switchToOffline=function(){j.setOffline()},n.switchToOnline=function(){j.setOnline()},n.initializeDb=function(a){if(!a)throw new Error("Db identifier not provided for initializeDb function");if(e.isInitialized())console.log("db already initialized");else{var b=this.configuration.dbName+a;l=new e(b,100*(new Date/1e3|0),o,a),l.upgradeEvent(function(a){_(o).each(function(b){if(_(a.target.transaction.db.objectStoreNames).contains(b.name)){if(a.target.transaction.objectStore(b.name).keyPath){var c=l.removeStore(b.name);c?(c.onsuccess=function(a){l.createStore(b.name,b.key)},request.onerror=function(a){console.log(a)}):l.createStore(b.name,b.key,a)}console.log("Store "+b+"already exist and will be not created again")}else l.createStore(b.name,b.key,a)}),_(p).each(function(b){_(a.target.transaction.db.objectStoreNames).contains(b.name)&&l.removeStore(b.name,a)})}),l.openEvent(function(){r(o)})}},a.$on("hyphenOnline",function(a){l&&r(o)});var q,r=function(a){q=c.defer();var b=[];return _(a).each(function(a){var c=l.getStoreData(a);b.push(c)}),c.all(b).then(function(a){m.synchronize(a)},function(a){console.log(a)}),b};return n}],a}]),jsHyphen.factory("HyphenSynchronizer",["$rootScope","HyphenDataStore","$injector","HyphenIndexDb","$q",function(a,b,c,d,e){var f=function(a){this.configuration=a};return f.prototype.syncedStors=[],f.prototype.sortStores=function(a){return _(a).sortBy(function(a){return a.model.priority})},f.prototype.chainStoreSync=function(b){var c=this,d=this.stores[0];d?(d.data.length>0&&c.syncedStors.push(angular.copy(d)),a.$broadcast("syncStoreStart",d),c.synchronizeStore(d).then(function(e){a.$broadcast("syncStoreSuccess",d,e),b.shift(),c.chainStoreSync(b)},function(b){a.$broadcast("syncError",b)})):(a.$broadcast("syncSuccess",c.syncedStors),c.syncedStors=[])},f.prototype.synchronize=function(b){a.$broadcast("syncStart",b),this.stores=this.sortStores(b),this.chainStoreSync(this.stores)},f.prototype.synchronizeStore=function(f){var g=this,h=[];if(f.data.length>0){var i=c.get(f.model.name);_(f.data).each(function(c){var e,j=c[f.model.key];switch(a.$broadcast("syncRecordStart",c),c.action){case"new":e=i["new"](angular.copy(c)).then(function(c){g.updateIds(j,c.data[f.model.key],f.model.key,f.model.foreignKeys),b.getStores()[f.model.name].remove(j),d.deleteRecord(f.model.name,j),a.$broadcast("syncRecordSuccess",c)},function(a){d.deleteRecord(f.model.name,j),console.log("can not remove synchronized record for 'Add' action with id = "+a)});break;case"updated":e=i.update(c).then(function(b){d.deleteRecord(f.model.name,j),a.$broadcast("syncRecordSuccess",b)},function(a){console.log("can not remove synchronized record for 'Update' action with id = "+a)});break;case"deleted":e=i["delete"](c).then(function(b){d.deleteRecord(f.model.name,c[f.model.key]),a.$broadcast("syncRecordSuccess",b)},function(a){console.log("can not remove synchronized record for 'Delete' action with id = record[syncStore.model.key]. "+a)});break;default:console.log("action not defined")}h.push(e)})}return e.all(h)},f.prototype.updateIds=function(a,b,c,d){_(this.stores).each(function(c){_(c.data).each(function(c){_(d).each(function(d){Number(c[d])===Number(a)&&(c[d]=b)})})})},f.prototype.removeSyncedRecord=function(a,b){_(this.stores).each(function(c){c.data=_(c.data).filter(function(c){return c[b]===a})})},f}]),jsHyphen.factory("HyphenDataStore",["HyphenDataModel",function(a){var b=function(c,d,e){b.prototype.stores[c]=new a(d,c,e)};return b.prototype.stores={},b.actions={},b.actions["delete"]=function(a,c){b.prototype.stores[c].removeDataOnline(a)},b.actions.save=function(a,c){b.prototype.stores[c].addData(a)},b.actions.custom=function(a,c,d){d.responseHandler(a,b.actions)},b.saveResult=function(a,c,d){d.processResponse!==!1&&(d.responseHandler?d.responseHandler(a,b.prototype.stores):"delete"===d.method||"delete"===d.action?b.prototype.stores[c].remove(a):b.prototype.stores[c].add(a))},b.getStores=function(){return b.prototype.stores},b.clearStores=function(){_(b.prototype.stores).each(function(a){a.data=[]})},b}]),jsHyphen.factory("BasicModel",["ApiCallFactory","HyphenDataStore","$injector","$q","CacheService","OfflineOnlineService","$rootScope",function(a,b,c,d,e,f,g){var h=function(h,i){this.entityModel=null;try{this.entityModel=c.get(h.model)}catch(j){throw new Error("Model not defned for: "+h.model+j.message)}var k=new b(h.model,this.entityModel,h.key);this.dataModel=k.stores[h.model],this.api={},this.api.loading=0;var l=new a;_(h.rest).each(function(a){var c=this,j=l.createApiCall(a,i,h.model);this.api[a.name]={},c.api[a.name].loading=0,this.api[a.name].call=function(l){var m,n=d.defer(),o=a.name+h.model+JSON.stringify(l);if(f.getState())e.isCached(o)?n.resolve([]):(j.dataSet=c.api[a.name].data,m=j.invoke.call(j,l),c.api[a.name].loading++,c.api.loading++,c.api[a.name].loaded=!1,m.then(function(d){c.api[a.name].loading--,c.api.loading--,c.api[a.name].loaded=!0,n.resolve(angular.copy(d)),d.data=i.responseInterceptor?i.responseInterceptor(d.data,a,k.stores[h.model]):d.data,b.saveResult(d.data,h.model,a)},function(b){c.api[a.name].loading--,c.api.loading--,n.reject(b);var d={data:c.api[a.name].data,warning:"api_call_failure",params:l,config:a,reason:b};g.$broadcast("apiCallFailure",d)}));else if(c.entityModel[a.name+"Offline"]&&a.offline)c.entityModel[a.name+"Offline"](l,c.api[a.name].data,b.prototype.stores),n.resolve(c.api[a.name].data);else{if(a.offline){var p="No offline method: "+h.model+"."+a.name+"Offline";throw console.warn(p),new Error(p)}var q={data:c.api[a.name].data,warning:"offline_not_supported",params:l,config:a};n.resolve(q),g.$broadcast("onNotSupportedMethodCall",q)}if(a.cache&&"get"!==a.method)throw new Error("Cache option can be switch on only for get api calls");return a.cache&&"get"===a.method&&!e.isCached(o)&&e.addUrl(o),n.promise}},this)};return h}]),jsHyphen.factory("CacheService",["HyphenDataStore",function(a){var b=[];return this.addUrl=function(a){b.push(a)},this.isCached=function(a){var c=_(b).filter(function(b){return b===a});return c.length>0?!0:!1},this.clearCache=function(){a.clearStores(),b=[]},this}]),jsHyphen.factory("ApiCallFactory",["HyphenPost","HyphenGet","HyphenPut","HyphenDelete",function(a,b,c,d){var e=function(){};return e.prototype.callType=b,e.prototype.createApiCall=function(e,f,g){switch(e.method){case"get":this.callType=b;break;case"post":this.callType=a;break;case"put":this.callType=c;break;case"delete":this.callType=d}return new this.callType(e,f,g)},e}]),jsHyphen.factory("OfflineOnlineService",["$rootScope","$timeout",function(a,b){var c,d=!0,e=!1;return this.getState=function(){return d},this.setOffline=function(){d=!1,e=!0,a.$broadcast("hyphenOffline")},this.setOnline=function(){e=!1,d=!0,a.$broadcast("hyphenOnline")},window.addEventListener("online",function(){e||(c=b(function(){d=!0,a.$broadcast("hyphenOnline")},5e3))}),window.addEventListener("offline",function(){e||(c&&b.cancel(c),b(function(){d=!1,a.$broadcast("hyphenOffline")}))}),this}])}(),jsHyphen.factory("HyphenIndexDb",["$q",function(a){var b=function(a,c){var d=this,e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;e||console.log("Indexed db not supported, offline mode not supported");var f;f=c?e.open(a,c):e.open(a),f.onsuccess=function(a){b.db=a.target.result,d.openEvent&&d.openEvent(a)},f.onerror=function(a){console.log(a)},f.onupgradeneeded=function(a){d.upgradeEvent&&d.upgradeEvent(a)},f.oncomplete=function(a){console.log(a)}};return b.closeDb=function(){this.db=b.db,this.db&&(this.db.close(),this.db=null)},b.isInitialized=function(){return b.db?!0:!1},b.addRecordToStore=function(a,c,d){var e=b.db.transaction(c,"readwrite"),f=e.objectStore(c);f.add(a,d)},b.addOrUpdateRecord=function(a,c,d){var e=this,f=b.db.transaction(c,"readwrite"),g=f.objectStore(c),h=g.get(d);h.onerror=function(){console.log("can not get record "+a)},h.onsuccess=function(){h.result?e.updateRecord(a,c,d):e.addRecordToStore(a,c,d)}},b.updateRecordStore=function(a,c,d){var e=b.db.transaction(c,"readwrite").objectStore(c),f=e.get(d);f.onsuccess=function(){e.put(a,d)}},b.prototype.getStoreData=function(c){var d=b.db.transaction(c.name,"readwrite"),e=d.objectStore(c.name),f=e.openCursor(),g=[],h=a.defer();return f.onsuccess=function(a){var b=a.target.result;b?(g.push(b.value),b["continue"]()):h.resolve({data:g,model:c})},f.onerror=function(a){h.resolve(a)},h.promise},b.deleteRecord=function(a,c){var d=b.db.transaction(a,"readwrite").objectStore(a);d["delete"](c)},b.prototype.createStore=function(a,b,c){var d=c.target.result.createObjectStore(a,{autoIncrement:!1});return d},b.prototype.removeStore=function(a,b){var c=b.target.result.deleteObjectStore(a,b);return c},b.prototype.upgradeEvent=function(a){return this.upgradeEvent=a},b.prototype.openEvent=function(a){return this.openEvent=a},b}]),jsHyphen.factory("HyphenDataModel",["HyphenIndexDb","OfflineOnlineService",function(a,b){var c=function(a,b,c){this.model=a,this.modelName=b,this.key=c,this.data=[];var d=this;this.sorted=!1,a.indexes&&Object.keys(a.indexes).forEach(function(b){d["getBy"+a.indexes[b]]=function(c){return d["index"+a.indexes[b]]||(d["index"+a.indexes[b]]=_(d.getData()).indexBy(function(a){return a[b]})),d["index"+a.indexes[b]][c]}}),a.groups&&Object.keys(a.groups).forEach(function(b){d["getGroupBy"+a.groups[b]]=function(c){return d["group"+a.groups[b]]||(d["group"+a.groups[b]]=_(d.getData()).groupBy(function(a){return a[b]})),d["group"+a.groups[b]][c]}})};c.prototype.data=[];var d=function(){var a=this;a.model.indexes&&Object.keys(a.model.indexes).forEach(function(b){a["index"+a.model.indexes[b]]=null})},e=function(){var a=this;a.model.groups&&Object.keys(a.model.groups).forEach(function(b){a["group"+a.model.groups[b]]=null})};return c.prototype.getData=function(){var a=this;return a.model.sort&&!a.sorted&&(this.data=this.data=_(this.data).sortBy(function(b){return a.model.sort.desc?b[a.model.sort.desc]?b[a.model.sort.desc].toLowerCase():b[a.model.sort.desc]:a.model.sort.asc?b[a.model.sort.asc]?b[a.model.sort.asc].toLowerCase():b[a.model.sort.asc]:void 0}),a.model.sort.desc&&(this.data=this.data.reverse()),a.sorted=!0),this.data},c.prototype.where=function(a){return _(this.data).filter(function(b){return b[a.prop]===a.value})},c.prototype.remove=function(c,f){var g=this,h=g.key,i=Array.isArray(c)?c:[c];_(i).each(function(c){if(b.getState()||f){var d=c&&c[h]?c[h]:c;this.data=_(this.data).filter(function(a){return a[h]!==d})}else{"new"===c.action?a.deleteRecord(g.modelName,c[h]):(c.action="deleted",a.addOrUpdateRecord(c,g.modelName,c[h]));var e=c&&c[h]?c[h]:c;this.data=_(this.data).filter(function(a){return a[h]!==e})}},this),d.call(this),e.call(this),g.sorted=!1},c.prototype.add=function(c,f){var g=this,h=JSON.parse(JSON.stringify(c)),i=g.key,j=Array.isArray(h)?h:[h];_(j).each(function(c){if(!c[i]&&0!=c[i])throw new Error("Key is not defined for '"+g.modelName+"', record cannot be added. Record"+c);var d=_(g.data).find(function(a){return a[i]===c[i]});if(d){var e=_.extend(new g.model(c),c);g.data=_([e].concat(g.data)).uniq(!1,function(a){return a[i]}),b.getState()||f||("new"!==c.action&&(c.action="updated"),a.updateRecordStore(c,g.modelName,c[i]))}else b.getState()||f||(c.action="new",a.addRecordToStore(c,g.modelName,c[i])),c=_.extend(new g.model(c),c),g.data.push(c)}),d.call(this),e.call(this),g.sorted=!1},c}]),jsHyphen.factory("HyphenCallBase",["$http",function(a){var b=function(b,c){this.httpOptions=b,this.hyphenConfiguration=c,this.$http=a,this.config={}};b.prototype.urlParser=function(a,b){for(var c in b)a=a.replace(":"+c,b[c]);return a};var c=function(a,b){return a.match(b+"$")===b};return b.prototype.invoke=function(a){this.config=angular.copy(this.httpOptions);var b="";return c(this.hyphenConfiguration.baseUrl,"/")||(b=this.hyphenConfiguration.baseUrl),a?this.config.url=b+this.urlParser(this.httpOptions.url,a):this.config.url=b+this.httpOptions.url,this.config.data=this.dataSet,this.hyphenConfiguration.requestInterceptor&&(this.config=this.hyphenConfiguration.requestInterceptor(this.config)),this.config.cache=!1,this.$http(this.config)},b}]),jsHyphen.factory("HyphenGet",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.config.method="GET"};return b.prototype=Object.create(a.prototype),b}]),jsHyphen.factory("HyphenPost",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.config.method="POST"};return b.prototype=Object.create(a.prototype),b.prototype.dataSet=null,b}]),jsHyphen.factory("HyphenPut",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.httpOptions=b,this.config.method="PUT"};return b.prototype=Object.create(a.prototype),b.prototype.dataSet=null,b}]),jsHyphen.factory("HyphenDelete",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.httpOptions=b,this.config.method="DELETE"};return b.prototype=Object.create(a.prototype),b}]);