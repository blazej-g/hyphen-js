/**
 * Hyphen Js - generic Angular App data layer
 * @version v0.0.6 - 2015-12-04 * @link 
 * @author Blazej Grzelinski
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */jsHyphen.factory("HyphenDataModel",function(){var a=function(a,b,c){this.modelName=b,this.data=[],this.model=a;var d=this;_(a.indexes).each(function(a){d["getBy"+a.name]=function(b){return d["index"+a.name]||(d["index"+a.name]=_(d.data).indexBy(function(b){return b[a.key]})),d["index"+a.name][b]}})},b=function(){var a=this;_(this.model.indexes).each(function(b){a["index"+b.name]=null})};return a.prototype.getData=function(){return this.data},a.prototype.removeData=function(a){var c=this.model.key,a=Array.isArray(a)?a:[a];_(a).each(function(a){a=a&&a[c]?a[c]:a,this.data=_(this.data).filter(function(b){return b[c]!=a})},this),b.call(this)},a.prototype.addData=function(a){a=JSON.parse(JSON.stringify(a));var c=this.model.key,a=Array.isArray(a)?a:[a];this.data=_(a).chain().map(function(a){return _.extend(new this.model(a),a)},this).concat(this.data).uniq(!1,function(a){return a[c]}).value(),b.call(this)},a}),jsHyphen.factory("HyphenCallBase",["$http",function(a){var b=function(b,c){this.httpOptions=b,this.hyphenConfiguration=c,this.$http=a,this.config={}};b.prototype.urlParser=function(a,b){var b=Array.isArray(b)?b:[b],c=a.split("/"),d=0;return _(c).each(function(a,e){-1!=a.indexOf(":")&&(c[e]=b[d],d++)}),c.join("/")};var c=function(a,b){return a.match(b+"$")==b};return b.prototype.invoke=function(a){return c(this.hyphenConfiguration.baseUrl,"/")&&(this.hyphenConfiguration.baseUrl=this.hyphenConfiguration.baseUrl.substring(0,this.hyphenConfiguration.baseUrl.length-1)),this.config.url=this.hyphenConfiguration.baseUrl+"/"+this.urlParser(this.httpOptions.url,a),this.config.data=this.dataSet,this.hyphenConfiguration.requestInterceptor&&(this.config=this.hyphenConfiguration.requestInterceptor(this.config)),this.$http(this.config)},b}]),jsHyphen.factory("HyphenGet",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.config.method="GET"};return b.prototype=Object.create(a.prototype),b}]),jsHyphen.factory("HyphenPost",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.config.method="POST"};return b.prototype=Object.create(a.prototype),b.prototype.dataSet=null,b}]),jsHyphen.factory("HyphenPut",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.httpOptions=b,this.config.method="PUT"};return b.prototype=Object.create(a.prototype),b.prototype.dataSet=null,b}]),jsHyphen.factory("HyphenDelete",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.httpOptions=b,this.config.method="DELETE"};return b.prototype=Object.create(a.prototype),b}]),jsHyphen.factory("IndexedDbConcreteCommands",["$q",function(){var a=function(){};a.prototype.openDataBase=function(a){window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction||{READ_WRITE:"readwrite"},window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;return this.request=window.indexedDB.open(a.name,a.version),b(this.request)},a.prototype.clearStores=function(a){var c=a.target.result,d=c.objectStoreNames,e=null;return d.length>0&&Object.keys(d).forEach(function(a){e=c.deleteObjectStore(d[a])}),e?b(e):b(a,!0)},a.prototype.createStores=function(a,c){var d=a.target.result,e=null;for(var f in c)e=d.createObjectStore(c[f].name,{autoIncrement:!1,keyPath:c[f].key});return e?b(e):b(a,!0)},a.prototype.addData=function(a,c){var d=self.db.transaction(c,"readwrite"),c=d.objectStore(c);b(c.add(a))},a.prototype.removeData=function(){},a.prototype.getDirtyData=function(){};var b=function(a,b){var c=new Promise(function(c,d){b||(a.onsuccess=function(a){c({data:a})},a.onerror=function(a){console.log(a.target.error.message),d(a)},a.onupgradeneeded=function(a){c({data:a})},a.oncomplete=function(a){c({data:a})})});return b?Promise.resolve(a):c};return new a}]),jsHyphen.factory("Command",[function(){var a=function(a){this.execute=a};return a}]),jsHyphen.factory("DbCommands",["Command","IndexedDbConcreteCommands",function(a,b){var c=function(){};return c.prototype.OpenDbCommand=function(){return new a(b.openDataBase)},c.prototype.ClearDbCommand=function(){return new a(b.clearStores)},c.prototype.CreateDbCommand=function(){return new a(b.createStores)},c.prototype.AddRecordDbCommand=function(){return new a(b.createRecord)},new c}]),jsHyphen.factory("HyphenIndexDb",["DbCommands",function(a){var b=function(c,d,e){var f=new a.OpenDbCommand,g=new a.ClearDbCommand,h=new a.CreateDbCommand,i=(new a.AddRecordDbCommand,f.execute({version:c,name:d}));i.then(function(a){if("upgradeneeded"==a.data.type){var b=g.execute(a.data);b.then(function(a){var b=h.execute(a,e);b.then(function(a){},function(a){})},function(a){})}},function(a){console.log("Failed: "+a)}),b.prototype.addObject=function(){}};return b}]);var jsHyphen=angular.module("jsHyphen",[]);!function(){jsHyphen.provider("Hyphen",[function(){var a={};return a.initialize=function(){},a.$get=["$http","$q","HyphenIndexDb","ModelsAbstractFactory","BasicModel",function(a,b,c,d,e){var f={};return f.initialize=function(a){a.model.forEach(function(b){var c=new d;c.registerModel(b.model,e),f[b.model]=c.getModel(b,a)})},window.addEventListener("online",function(){console.log("Is online")}),window.addEventListener("offline",function(){console.log("is offline")}),f}],a}]),jsHyphen.factory("HyphenDataStore",["HyphenDataModel",function(a){var b=function(c,d){b.prototype.stores[c]=new a(d,c)};return b.prototype.stores={},b.saveResult=function(a,c,d){0!=d.processResponse&&a.then(function(a){d.responseHandler?d.responseHandler(a,b.prototype.stores):"delete"==d.method||"delete"==d.action?b.prototype.stores[c].removeData(a.data):b.prototype.stores[c].addData(a.data)})},b}]),jsHyphen.factory("DefaultModel",["Hyphen",function(a){var b=function(a){};return b.key="_id",b.indexes=[{name:"Id",key:"id"},{name:"_Id",key:"_id"}],b}]),jsHyphen.factory("BasicModel",["ApiCallFactory","HyphenDataStore","$injector",function(a,b,c){var d=function(d,e){var f=null;try{f=c.get(d.model)}catch(g){f=c.get("DefaultModel")}var h=new b(d.model,f);this.dataModel=h.stores[d.model],this.api={};var i=new a;_(d.rest).each(function(a){var c=this,f=i.createApiCall(a,e,d.model);this.api[a.name]={},c.api[a.name].loading=!1,this.api[a.name].call=function(e){f.dataSet=c.api[a.name].data;var g=f.invoke.call(f,e);return c.api[a.name].loading=!0,g.then(function(){c.api[a.name].loading=!1},function(){c.api[a.name].loading=!1}),c.api[a.name].promise=g,b.saveResult(g,d.model,a),g}},this)};return d}]),jsHyphen.factory("ModelsAbstractFactory",[function(){var a=function(){this.types={}};return a.prototype.registerModel=function(a,b){b.prototype;this.types[a]=b},a.prototype.getModel=function(a,b){var c=this.types[a.model];return c?new c(a,b):null},a}]),jsHyphen.factory("ApiCallFactory",["HyphenPost","HyphenGet","HyphenPut","HyphenDelete",function(a,b,c,d){var e=function(){};return e.prototype.callType=b,e.prototype.createApiCall=function(e,f,g){switch(e.method){case"get":this.callType=b;break;case"post":this.callType=a;break;case"put":this.callType=c;break;case"delete":this.callType=d}return new this.callType(e,f,g)},e}])}();