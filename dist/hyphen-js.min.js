/**
 * Hyphen Js - Generic Angular application data layer
 * @version v0.0.0 - 2017-02-04 * @link 
 * @author Blazej Grzelinski
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */var jsHyphen=angular.module("jsHyphen",[]);jsHyphen.provider("Hyphen",[function(){var a={};return a.initialize=function(){},a.$get=["$rootScope","$http","$q","$injector","$timeout","HyphenDataProvider","HyphenAPI","HyphenCache",function(a,b,c,d,e,f,g,h){var i={};return i.initialize=function(a){this.configuration=a,_(a.model).each(function(b,c,d){b.name=c,i[b.name]={},i[b.name].provider=new f(i,b,a)}),_(a.model).each(function(b,c,d){b.name=c,i[b.name].api=new g(i,b,a)})},i.dispose=function(){_(this.configuration.model).forEach(function(a){i[a.name].provider.clearData()}),h.clearCache()},i}],a}]),jsHyphen.factory("HyphenAPI",["ApiCallFactory","$injector","$q",function(a,b,c){var d=function(b,d,e){this.hyphen=b,this.loading=0,this.modelConfiguration=d,this.globalConfiguration=e;var f=this;_(d.rest).each(function(g){var h=this,i=new a(g,e,d.name);this[g.name]=function(a,d){var e=c.defer();e.promise.save=function(a,c){return e.promise.then(function(d){a||(a=f.modelConfiguration.model);var e=d.data;c&&(e=d.data[c]),b[f.modelConfiguration.name].provider.addData(e,a)}),e.promise},e.promise["delete"]=function(a,c){return e.promise.then(function(d){a||(a=f.modelConfiguration.model);var e=d.data;c&&(e=d.data[c]),b[f.modelConfiguration.name].provider.deleteData(e,a)}),e.promise};var j=i.getApiCall(a,d);return h[g.name].loading++,h.loading++,h[g.name].loaded=!1,j.then(function(a){h[g.name].loading--,h.loading--,h[g.name].loaded=!0,e.resolve(a)},function(a){e.reject(a)},function(a){e.notify(a)}),e.promise},h[g.name].loading=0},this)};return d}]),jsHyphen.factory("ApiCallFactory",["HyphenPost","HyphenGet","HyphenPut","HyphenDelete","HyphenFilePost","$q","HyphenCache",function(a,b,c,d,e,f,g){var h=function(f,g,h){switch(this.apiCallConfiguration=f,this.modelName=h,f.method){case"get":this.callType=b;break;case"post":this.callType=a;break;case"put":this.callType=c;break;case"delete":this.callType=d;break;case"filePost":this.callType=e}this.apiCall=new this.callType(f,g)};return h.prototype.getApiCall=function(a,b){var c=this.apiCallConfiguration.name+this.modelName+JSON.stringify(a);return g.isCached(c)?f.resolve({data:{cached:!0}}):(this.apiCallConfiguration.cache&&"get"===this.apiCallConfiguration.method&&g.addUrl(c),this.apiCall.invoke.call(this.apiCall,a,b))},h}]),jsHyphen.factory("HyphenCache",[function(){var a={};return this.addUrl=function(b){a[b]=!0},this.isCached=function(b){return a[b]},this.clearCache=function(){a={}},this}]),jsHyphen.factory("HyphenDataProvider",["$rootScope","$injector",function(a,b){var c=function(a,c,d){if(this.modelConfiguration=c,this.Hyphen=a,this.globalConfiguration=d,this.clearData(),!b.has(c.model))throw new Error("Model not defined for: "+c.model);this.modelClass=b.get(c.model);var e=this;e.modelClass.indexes&&Object.keys(e.modelClass.indexes).forEach(function(a){e["getBy"+e.modelClass.indexes[a]]=function(b){return e.getIndexedData(a,b)}}),e.modelClass.groups&&Object.keys(e.modelClass.groups).forEach(function(a){e["getGroupBy"+e.modelClass.groups[a]]=function(b){return e.getGroupedData(a,b)}})};return c.prototype.data=[],c.prototype.clearData=function(){this.data=[],this.clearIndexes()},c.prototype.clearIndexes=function(){this.indexedData={},this.groupedData={},this.sorted=!1},c.prototype.getIndexedData=function(a,b){return this.indexedData[a]||(this.indexedData[a]=_(this.getData()).indexBy(a)),this.indexedData[a][b]},c.prototype.getGroupedData=function(a,b){return this.groupedData[a]||(this.groupedData[a]=_(this.getData()).groupBy(a)),this.groupedData[a][b]?this.groupedData[a][b]:[]},c.prototype.where=function(a){var b="",c="";for(var d in a)b+=d+"|",c+=a[d]+"|";return this.groupedData[b]||(this.groupedData[b]=_(this.getData()).groupBy(function(b){var c="";for(var d in a)c+=b[d]+"|";return c})),this.groupedData[b][c]?this.groupedData[b][c]:[]},c.prototype.findOne=function(a){var b=this.where(a);return b.length>0?b[0]:null},c.prototype.getData=function(){var a=this;return a.modelClass.sort&&!a.sorted&&(this.data=this.data=_(this.data).sortBy(function(b){return a.modelClass.sort.desc?b[a.modelClass.sort.desc]?b[a.modelClass.sort.desc].toLowerCase():b[a.modelClass.sort.desc]:a.modelClass.sort.asc?b[a.modelClass.sort.asc]?b[a.modelClass.sort.asc].toLowerCase():b[a.modelClass.sort.asc]:void 0}),a.modelClass.sort.desc&&(this.data=this.data.reverse()),a.sorted=!0),this.data},c.prototype["delete"]=function(a){var b=this,c=a&&a[b.modelConfiguration.key]?a[b.modelConfiguration.key]:a;this.data=_(this.data).filter(function(a){return a[b.modelConfiguration.key]!==c})},c.prototype.save=function(a){var b=this,c=_(b.data).find(function(c){return c[b.modelConfiguration.key]===a[b.modelConfiguration.key]});if(c){var d=_.extend(new b.modelClass(a),a);b.data=_([d].concat(b.data)).uniq(!1,function(a){return a[b.modelConfiguration.key]})}else{var e=_.extend(new b.modelClass(a),a);b.data.push(e)}},c.prototype.addData=function(a,b){var c=this,d=null;d=b?this.globalConfiguration.model[b]:this.modelConfiguration;var a=Array.isArray(a)?a:[a];_(a).each(function(a){for(var b in d.embedObjects){var e=d.embedObjects[b];if(a[b]){var f=Array.isArray(a[b])?a[b]:[a[b]];c.addData(f,e),delete a[b]}}c.Hyphen[d.name].provider.save(a)}),c.Hyphen[d.name].provider.clearIndexes()},c.prototype.deleteData=function(a,b){var c=this;b?model=this.globalConfiguration.model[b]:model=this.modelConfiguration;var a=Array.isArray(a)?a:[a];_(a).each(function(a){for(var b in model.embedObjects){var d=model.embedObjects[b];if(a[b]){var e=Array.isArray(a[b])?a[b]:[a[b]];c.deleteData(e,d),delete a[b]}}c.Hyphen[model.name].provider["delete"](a)}),c.Hyphen[model.name].provider.clearIndexes()},c}]),jsHyphen.factory("HyphenCallBase",[function(){var a=function(a,b){this.httpOptions=a,this.hyphenConfiguration=b,this.config={}};a.prototype.urlParser=function(a,b){for(var c in b)a=a.replace(":"+c,b[c]);return a};var b=function(a,b){return a.match(b+"$")===b};return a.prototype.invoke=function(a,c){this.config=angular.copy(this.httpOptions);var d="";return b(this.hyphenConfiguration.baseUrl,"/")||(d=this.hyphenConfiguration.baseUrl),a?this.config.url=d+this.urlParser(this.httpOptions.url,a):this.config.url=d+this.httpOptions.url,this.config.data=c,this.hyphenConfiguration.requestInterceptor&&(this.config=this.hyphenConfiguration.requestInterceptor(this.config)),this.config.cache=!1,this.$http(this.config)},a}]),jsHyphen.factory("HyphenGet",["HyphenCallBase","$http",function(a,b){var c=function(c,d){a.call(this,c,d),this.$http=b};return c.prototype=Object.create(a.prototype),c}]),jsHyphen.factory("HyphenPost",["HyphenCallBase","$http",function(a,b){var c=function(c,d){a.call(this,c,d),this.$http=b};return c.prototype=Object.create(a.prototype),c}]),jsHyphen.factory("HyphenPut",["HyphenCallBase","$http",function(a,b){var c=function(c,d){a.call(this,c,d),this.$http=b};return c.prototype=Object.create(a.prototype),c}]),jsHyphen.factory("HyphenDelete",["HyphenCallBase","$http",function(a,b){var c=function(c,d){a.call(this,c,d),this.$http=b};return c.prototype=Object.create(a.prototype),c}]),jsHyphen.factory("HyphenFilePost",["HyphenCallBase","$http","$q",function(a,b,c){var d=function(b,d){a.call(this,b,d),this.httpOptions.method="POST",this.$http=function(a){var b=new XMLHttpRequest;b.open("POST",a.url,!0);var d=c.defer();return b.upload.addEventListener("progress",function(a){a.progress=Math.round(100*(a.loaded/a.total).toFixed(2)),d.notify(a)},!0),b.addEventListener("error",function(a){d.reject(a)},!0),b.addEventListener("abort",function(a){a.aborted=!0,d.reject(a)},!0),b.onreadystatechange=function(a){if((403==b.status||404==b.status||500==b.status||422==b.status)&&d.reject(a),4==b.readyState&&200==b.status){var a=JSON.parse(b.response);a.errors&&a.errors.file?d.reject(a):d.resolve({data:a})}},b.send(a.data),d.promise.abort=function(){b.abort()},d.promise}};return d.prototype=Object.create(a.prototype),d}]);