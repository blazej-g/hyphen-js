/**
 * Hyphen Js - Generic Angular application data layer
 * @version v0.0.199 - 2016-02-27 * @link 
 * @author Blazej Grzelinski
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */var jsHyphen=angular.module("jsHyphen",[]);!function(){jsHyphen.provider("Hyphen",[function(){var a={};return a.initialize=function(){},a.$get=["$rootScope","$http","$q","BasicModel","HyphenIndexDb","$injector","$timeout","CacheService","HyphenSynchronizer","OfflineOnlineService",function(a,b,c,d,e,f,g,h,i,j){var k,l,m,n={},o=[];n.initialize=function(a){this.configuration=a,k=a,m=new i(a),a.model.forEach(function(b){n[b.model]=new d(b,a),b.sync&&o.push({name:b.model,key:b.key,priority:b.priority,sync:b.sync,foreignKeys:b.foreignKeys})})},n.dispose=function(){h.clearCache(),e.closeDb()},n.getState=function(){return j.getState()},n.switchToOffline=function(){j.setOffline()},n.switchToOnline=function(){j.setOnline()},n.initializeDb=function(a){if(!a)throw new Error("Db identifier not provided for initializeDb function");if(e.isInitialized())console.log("db already initialized");else{var b=this.configuration.dbName+a;l=new e(b,this.configuration.dbVersion,o,a),e.upgradeEvent(function(a){_(o).each(function(b){_(a.target.transaction.db.objectStoreNames).contains(b.name)?console.log("Store "+b+"already exist and will be not created again"):e.createStore(b.name,b.key)})}),e.openEvent(function(){q(o)})}},a.$on("hyphenOnline",function(a){l&&q(o)});var p,q=function(a){p=c.defer();var b=[];return _(a).each(function(a){var c=e.getStoreData(a);b.push(c)}),c.all(b).then(function(a){m.synchronize(a)},function(a){console.log(a)}),b};return n}],a}]),jsHyphen.factory("HyphenSynchronizer",["$rootScope","HyphenDataStore","$injector","HyphenIndexDb","$q",function(a,b,c,d,e){var f=function(a){this.configuration=a};return f.prototype.syncedStors=[],f.prototype.sortStores=function(a){return _(a).sortBy(function(a){return a.model.priority})},f.prototype.chainStoreSync=function(b){var c=this,d=this.stores[0];d?(d.data.length>0&&c.syncedStors.push(angular.copy(d)),a.$broadcast("syncStoreStart",d),c.synchronizeStore(d).then(function(e){a.$broadcast("syncStoreSuccess",d,e),b.shift(),c.chainStoreSync(b)},function(b){a.$broadcast("syncError",b)})):(a.$broadcast("syncSuccess",c.syncedStors),c.syncedStors=[])},f.prototype.synchronize=function(b){a.$broadcast("syncStart",b),this.stores=this.sortStores(b),this.chainStoreSync(this.stores)},f.prototype.synchronizeStore=function(f){var g=this,h=[];if(f.data.length>0){var i=c.get(f.model.name);_(f.data).each(function(c){var e,j=c[f.model.key];switch(a.$broadcast("syncRecordStart",c),c.action){case"new":e=i["new"](angular.copy(c)).then(function(c){g.updateIds(j,c.data[f.model.key],f.model.key,f.model.foreignKeys),b.getStores()[f.model.name].remove(j),d.deleteRecord(f.model.name,j),a.$broadcast("syncRecordSuccess",c)},function(a){console.log("can not remove synchronized record for 'Add' action with id = "+a)});break;case"updated":e=i.update(c).then(function(b){d.deleteRecord(f.model.name,j),a.$broadcast("syncRecordSuccess",b)},function(a){console.log("can not remove synchronized record for 'Update' action with id = "+a)});break;case"deleted":e=i["delete"](c).then(function(b){d.deleteRecord(f.model.name,c[f.model.key]),a.$broadcast("syncRecordSuccess",b)},function(a){console.log("can not remove synchronized record for 'Delete' action with id = record[syncStore.model.key]. "+a)});break;default:console.log("action not defined")}h.push(e)})}return e.all(h)},f.prototype.updateIds=function(a,b,c,d){_(this.stores).each(function(c){_(c.data).each(function(c){_(d).each(function(d){Number(c[d])===Number(a)&&(c[d]=b)})})})},f.prototype.removeSyncedRecord=function(a,b){_(this.stores).each(function(c){c.data=_(c.data).filter(function(c){return c[b]===a})})},f}]),jsHyphen.factory("HyphenDataStore",["HyphenDataModel",function(a){var b=function(c,d,e){b.prototype.stores[c]=new a(d,c,e)};return b.prototype.stores={},b.actions={},b.actions["delete"]=function(a,c){b.prototype.stores[c].removeDataOnline(a)},b.actions.save=function(a,c){b.prototype.stores[c].addData(a)},b.actions.custom=function(a,c,d){d.responseHandler(a,b.actions)},b.saveResult=function(a,c,d){d.processResponse!==!1&&(d.responseHandler?d.responseHandler(a,b.prototype.stores):"delete"===d.method||"delete"===d.action?b.prototype.stores[c].remove(a):b.prototype.stores[c].add(a))},b.getStores=function(){return b.prototype.stores},b.clearStores=function(){_(b.prototype.stores).each(function(a){a.data=[]})},b}]),jsHyphen.factory("BasicModel",["ApiCallFactory","HyphenDataStore","$injector","$q","CacheService","OfflineOnlineService",function(a,b,c,d,e,f){var g=function(g,h){this.entityModel=null;try{this.entityModel=c.get(g.model)}catch(i){throw new Error("Model not defned for: "+g.model+i.message)}var j=new b(g.model,this.entityModel,g.key);this.dataModel=j.stores[g.model],this.api={};var k=new a;_(g.rest).each(function(a){var c=this,i=k.createApiCall(a,h,g.model);this.api[a.name]={},c.api[a.name].loading=0,this.api[a.name].call=function(k){var l,m=d.defer(),n=a.name+g.model+JSON.stringify(k);if(f.getState())e.isCached(n)?m.resolve([]):(i.dataSet=c.api[a.name].data,l=i.invoke.call(i,k),c.api[a.name].loading++,c.api[a.name].loaded=!1,l.then(function(d){c.api[a.name].loading--,c.api[a.name].loaded=!0,m.resolve(angular.copy(d)),d.data=h.responseInterceptor?h.responseInterceptor(d.data,a,j.stores[g.model]):d.data,b.saveResult(d.data,g.model,a)},function(b){c.api[a.name].loading--,m.reject(b)}));else{if(!c.entityModel[a.name+"Offline"]){var o="No offline method: "+g.model+"."+a.name+"Offline";throw console.warn(o),new Error(o)}c.entityModel[a.name+"Offline"](k,c.api[a.name].data,b.prototype.stores),m.resolve(c.api[a.name].data)}if(a.cache&&"get"!==a.method)throw new Error("Cache option can be switch on only for get parameters");return a.cache&&"get"===a.method&&!e.isCached(n)&&e.addUrl(n),m.promise}},this)};return g}]),jsHyphen.factory("CacheService",["HyphenDataStore",function(a){var b=[];return this.addUrl=function(a){b.push(a)},this.isCached=function(a){var c=_(b).filter(function(b){return b===a});return c.length>0?!0:!1},this.clearCache=function(){a.clearStores(),b=[]},this}]),jsHyphen.factory("ApiCallFactory",["HyphenPost","HyphenGet","HyphenPut","HyphenDelete",function(a,b,c,d){var e=function(){};return e.prototype.callType=b,e.prototype.createApiCall=function(e,f,g){switch(e.method){case"get":this.callType=b;break;case"post":this.callType=a;break;case"put":this.callType=c;break;case"delete":this.callType=d}return new this.callType(e,f,g)},e}]),jsHyphen.factory("OfflineOnlineService",["$rootScope","$timeout",function(a,b){var c,d=!0,e=!1;return this.getState=function(){return d},this.setOffline=function(){d=!1,e=!0,a.$broadcast("hyphenOffline")},this.setOnline=function(){e=!1,d=!0,a.$broadcast("hyphenOnline")},window.addEventListener("online",function(){e||(c=b(function(){d=!0,a.$broadcast("hyphenOnline")},5e3))}),window.addEventListener("offline",function(){e||(c&&b.cancel(c),b(function(){d=!1,a.$broadcast("hyphenOffline")}))}),this}])}(),jsHyphen.factory("IndexedDbCommandBase",["$q",function(){var a=function(a,b){var c=this;this.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,this.indexedDB||console.log("Indexed db not supported, offline mode not supported");var d=window.indexedDB.open(a,b);d.onsuccess=function(a){c.db=a.target.result,c.stores=a.target.result.objectStoreNames,c.openEvent&&c.openEvent(a),console.log("Local db initialized")},d.onerror=function(a){console.log(a)},d.onupgradeneeded=function(a){c.db=a.target.result,c.upgradeEvent&&c.upgradeEvent(a)},d.oncomplete=function(a){console.log(a)}};return a.prototype.isInitialized=function(){return this.db?!0:!1},a.prototype.registerPromise=function(a){var b=new Promise(function(b,c){a.onsuccess=function(a){b({data:a})},a.onerror=function(a){c(a)},a.onupgradeneeded=function(a){b({data:a})},a.oncomplete=function(a){b({data:a})}});return b},a}]),jsHyphen.factory("IndexedDbCommands",["$q","IndexedDbCommandBase",function(a,b){var c=function(a,c){b.call(this,a,c)};return c.prototype=Object.create(b.prototype),c.prototype.closeDb=function(){this.db&&(this.db.close(),this.db=null)},c.prototype.clearStores=function(a,b){var c,d,e=this;return b.length>0?(Object.keys(a).forEach(function(b){d=e.db.deleteObjectStore(a[b].name)}),c=new Promise(function(a,b){d.onsuccess=function(b){a({data:b})},d.onerror=function(a){b(a)},d.onupgradeneeded=function(b){a({data:b})},d.oncomplete=function(b){a({data:b})}})):c=new Promise(function(a){a()}),c},c.prototype.createStore=function(a,b){var c=this.db.createObjectStore(a,{autoIncrement:!1,keyPath:b});return c},c.prototype.clear=function(a){var b=this.db.transaction(a,"readwrite"),c=b.objectStore(a),d=c.clear();return this.registerPromise(d)},c.prototype.clearSynchronized=function(a){var b=this.db.transaction(a,"readwrite"),c=b.objectStore(a),d=c.openCursor();d.onsuccess=function(a){var b=a.target.result;b&&(b.value.action&&c["delete"](b.value),b["continue"]())}},c.prototype.createStores=function(a){var b,c;for(var d in a)c=this.db.createObjectStore(a[d].name,{autoIncrement:!1,keyPath:a[d].key});return b=new Promise(function(a,b){c.onsuccess=function(b){a({data:b})},c.onerror=function(a){b(a)},c.onupgradeneeded=function(b){a({data:b})},c.oncomplete=function(b){a({data:b})}})},c.prototype.addRecord=function(a,b){var c=this.db.transaction(b,"readwrite"),d=c.objectStore(b);d.add(a)},c.prototype.addOrUpdateRecord=function(a,b,c){var d=this,e=this.db.transaction(b,"readwrite"),f=e.objectStore(b),g=f.get(c);g.onerror=function(){console.log("can not get record "+a)},g.onsuccess=function(){g.result?d.updateRecord(a,b,c):d.addRecord(a,b)}},c.prototype.updateRecord=function(a,b,c){var d=this.db.transaction(b,"readwrite").objectStore(b),e=d.get(c);e.onsuccess=function(){d.put(a)}},c.prototype.deleteRecord=function(a,b){var c=this.db.transaction(a,"readwrite").objectStore(a);c["delete"](b)},c.prototype.getStoreData=function(b){var c=this.db.transaction(b.name,"readwrite"),d=c.objectStore(b.name),e=d.openCursor(),f=[],g=a.defer();return e.onsuccess=function(a){var c=a.target.result;c?(f.push(c.value),c["continue"]()):g.resolve({data:f,model:b})},e.onerror=function(a){g.resolve(a)},g.promise},c}]),jsHyphen.factory("HyphenIndexDb",["IndexedDbCommands",function(a){var b,c=function(c,d,e){b=new a(c,d,e)};return c.clearStores=function(a,c){return b.clearStores(a,c)},c.getStoreData=function(a){return b.getStoreData(a)},c.createStores=function(a){return b.createStores(a)},c.close=function(){return b.closeDb()},c.addRecordToStore=function(a,c){return b.addRecord(a,c)},c.updateRecordStore=function(a,c,d){return b.updateRecord(a,c,d)},c.deleteRecord=function(a,c){return b.deleteRecord(a,c)},c.upgradeEvent=function(a){return b.upgradeEvent=a},c.openEvent=function(a){return b.openEvent=a},c.createStore=function(a,c){return b.createStore(a,c)},c.clear=function(a){return b.clear(a)},c.getStores=function(){return b.stores},c.clearSynchronized=function(a){return b.clearSynchronized(a)},c.addOrUpdateRecord=function(a,c,d){return b.addOrUpdateRecord(a,c,d)},c.isInitialized=function(){return b?b.isInitialized():!1},c.closeDb=function(){b&&b.closeDb()},c}]),jsHyphen.factory("HyphenDataModel",["HyphenIndexDb","OfflineOnlineService",function(a,b){var c=function(a,b,c){this.model=a,this.modelName=b,this.key=c,this.data=[];var d=this;this.sorted=!1,a.indexes&&Object.keys(a.indexes).forEach(function(b){d["getBy"+a.indexes[b]]=function(c){return d["index"+a.indexes[b]]||(d["index"+a.indexes[b]]=_(d.getData()).indexBy(function(a){return a[b]})),d["index"+a.indexes[b]][c]}}),a.groups&&Object.keys(a.groups).forEach(function(b){d["getGroupBy"+a.groups[b]]=function(c){return d["group"+a.groups[b]]||(d["group"+a.groups[b]]=_(d.getData()).groupBy(function(a){return a[b]})),d["group"+a.groups[b]][c]}})};c.prototype.data=[];var d=function(){var a=this;a.model.indexes&&Object.keys(a.model.indexes).forEach(function(b){a["index"+a.model.indexes[b]]=null})},e=function(){var a=this;a.model.groups&&Object.keys(a.model.groups).forEach(function(b){a["group"+a.model.groups[b]]=null})};return c.prototype.getData=function(){var a=this;return a.model.sort&&!a.sorted&&(this.data=this.data=_(this.data).sortBy(function(b){return a.model.sort.desc?b[a.model.sort.desc]?b[a.model.sort.desc].toLowerCase():b[a.model.sort.desc]:a.model.sort.asc?b[a.model.sort.asc]?b[a.model.sort.asc].toLowerCase():b[a.model.sort.asc]:void 0}),a.model.sort.desc&&(this.data=this.data.reverse()),a.sorted=!0),this.data},c.prototype.where=function(a){return _(this.data).filter(function(b){return b[a.prop]===a.value})},c.prototype.remove=function(c,f){var g=this,h=g.key,i=Array.isArray(c)?c:[c];_(i).each(function(c){if(b.getState()||f){var d=c&&c[h]?c[h]:c;this.data=_(this.data).filter(function(a){return a[h]!==d})}else{"new"===c.action?a.deleteRecord(g.modelName,c[h]):(c.action="deleted",a.addOrUpdateRecord(c,g.modelName,c[h]));var e=c&&c[h]?c[h]:c;this.data=_(this.data).filter(function(a){return a[h]!==e})}},this),d.call(this),e.call(this),g.sorted=!1},c.prototype.add=function(c,f){var g=this,h=JSON.parse(JSON.stringify(c)),i=g.key,j=Array.isArray(h)?h:[h];_(j).each(function(c){if(!c[i])throw new Error("Key is not defined for '"+g.modelName+"', record cannot be added. Record"+c);var d=_(g.data).find(function(a){return a[i]===c[i]});if(d){var e=_.extend(new g.model(c),c);g.data=_([e].concat(g.data)).uniq(!1,function(a){return a[i]}),b.getState()||f||("new"!==c.action&&(c.action="updated"),a.updateRecordStore(c,g.modelName,c[i]))}else b.getState()||f||(c.action="new",a.addRecordToStore(c,g.modelName)),c=_.extend(new g.model(c),c),g.data.push(c)}),d.call(this),e.call(this),g.sorted=!1},c}]),jsHyphen.factory("HyphenCallBase",["$http",function(a){var b=function(b,c){this.httpOptions=b,this.hyphenConfiguration=c,this.$http=a,this.config={}};b.prototype.urlParser=function(a,b){for(var c in b)a=a.replace(":"+c,b[c]);return a};var c=function(a,b){return a.match(b+"$")===b};return b.prototype.invoke=function(a){this.config=angular.copy(this.httpOptions);var b="";return c(this.hyphenConfiguration.baseUrl,"/")||(b=this.hyphenConfiguration.baseUrl),a?this.config.url=b+this.urlParser(this.httpOptions.url,a):this.config.url=b+this.httpOptions.url,this.config.data=this.dataSet,this.hyphenConfiguration.requestInterceptor&&(this.config=this.hyphenConfiguration.requestInterceptor(this.config)),this.config.cache=!1,this.$http(this.config)},b}]),jsHyphen.factory("HyphenGet",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.config.method="GET"};return b.prototype=Object.create(a.prototype),b}]),jsHyphen.factory("HyphenPost",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.config.method="POST"};return b.prototype=Object.create(a.prototype),b.prototype.dataSet=null,b}]),jsHyphen.factory("HyphenPut",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.httpOptions=b,this.config.method="PUT"};return b.prototype=Object.create(a.prototype),b.prototype.dataSet=null,b}]),jsHyphen.factory("HyphenDelete",["HyphenCallBase",function(a){var b=function(b,c){a.call(this,b,c),this.httpOptions=b,this.config.method="DELETE"};return b.prototype=Object.create(a.prototype),b}]);